[{"id":"3c42ee28.883e0a","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"fd4eee87.2465f8","type":"harmonyws-server","name":"Olohuone v2","ip":"192.168.1.229","debug":false},{"id":"b3b798b.57990e8","type":"ui_tab","name":"Z2M Admin","icon":"dashboard","disabled":false,"hidden":false},{"id":"dc2a486d.1fecb","type":"ui_tab","name":"Z2M Network map","icon":"dashboard","disabled":false,"hidden":true},{"id":"58a61e9c.6e7898","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"2ec0e647.0b10ba","type":"mqtt-broker","name":"docker-mosquitto","broker":"mosquitto","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"e4b2ca44.396d1","type":"mqtt in","z":"3c42ee28.883e0a","name":"nappi1","topic":"zigbee2mqtt/nappi1","qos":"2","datatype":"auto","broker":"2ec0e647.0b10ba","x":80,"y":100,"wires":[["4b807e.06774784"]]},{"id":"4b807e.06774784","type":"debug","z":"3c42ee28.883e0a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":230,"y":100,"wires":[]},{"id":"3542d091.861f88","type":"mqtt in","z":"3c42ee28.883e0a","name":"pistoke-tvtaso","topic":"zigbee2mqtt/pistoke-tvtaso","qos":"2","datatype":"auto","broker":"2ec0e647.0b10ba","x":100,"y":200,"wires":[["b46154b9.99c7c"]]},{"id":"b46154b9.99c7c","type":"debug","z":"3c42ee28.883e0a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":290,"y":200,"wires":[]},{"id":"21f5bf60.b75a88","type":"mqtt in","z":"3c42ee28.883e0a","name":"nappi1","topic":"zigbee2mqtt/nappi1","qos":"2","datatype":"auto","broker":"2ec0e647.0b10ba","x":90,"y":460,"wires":[["17bd2a9c.3d66a5"]]},{"id":"17bd2a9c.3d66a5","type":"json","z":"3c42ee28.883e0a","name":"","property":"payload","action":"","pretty":false,"x":270,"y":460,"wires":[["efd53aa9.8c54f"]]},{"id":"efd53aa9.8c54f","type":"switch","z":"3c42ee28.883e0a","name":"","property":"payload.click","propertyType":"msg","rules":[{"t":"eq","v":"single","vt":"str"},{"t":"eq","v":"long","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":460,"wires":[["f2654064.33856"],["7144c414.ed7394","910bbb82.066c3"]]},{"id":"e9e99d1e.d44328","type":"mqtt out","z":"3c42ee28.883e0a","name":"pistoke-tvtaso","topic":"zigbee2mqtt/pistoke-tvtaso/set","qos":"","retain":"","broker":"2ec0e647.0b10ba","x":960,"y":560,"wires":[]},{"id":"f2654064.33856","type":"change","z":"3c42ee28.883e0a","name":"{\"state\": \"ON\"}","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"state\": \"ON\"}","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":560,"wires":[["e9e99d1e.d44328"]]},{"id":"7ea83549.1bf8cc","type":"change","z":"3c42ee28.883e0a","name":"{\"state\": \"OFF\"}","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"state\": \"OFF\"}","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":600,"wires":[["e9e99d1e.d44328"]]},{"id":"b6f65158.a9dda8","type":"comment","z":"3c42ee28.883e0a","name":"TV tason ohjaus päälle/pois","info":"","x":160,"y":340,"wires":[]},{"id":"7144c414.ed7394","type":"harmonyws-activity","z":"3c42ee28.883e0a","name":"Harmony / off","server":"fd4eee87.2465f8","activity":"-1","x":380,"y":560,"wires":[[]]},{"id":"d50b9fff.258c18","type":"harmonyws-observer","z":"3c42ee28.883e0a","name":"Harmony olohuone tila","server":"fd4eee87.2465f8","startup":true,"toContext":false,"context":"flow","contextKeyActivity":"HarmonyHub","contextKeyAutomation":"automation","x":520,"y":100,"wires":[["909fb4ee.538458","f7d3061c.7f37"]]},{"id":"f0bf413e.ac75e8","type":"inject","z":"3c42ee28.883e0a","name":"Päälle","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"click\":\"single\"}","payloadType":"str","x":110,"y":520,"wires":[["17bd2a9c.3d66a5"]]},{"id":"13f95326.eae215","type":"inject","z":"3c42ee28.883e0a","name":"Pois päältä","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"click\":\"long\"}","payloadType":"str","x":120,"y":560,"wires":[["17bd2a9c.3d66a5"]]},{"id":"909fb4ee.538458","type":"change","z":"3c42ee28.883e0a","name":"","rules":[{"t":"set","p":"harmonyhub","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":100,"wires":[[]]},{"id":"910bbb82.066c3","type":"function","z":"3c42ee28.883e0a","name":"Odota Harmony off","func":"class Waiter {\n    constructor(timeout) {\n        this.timeout = timeout;\n        this.intervalHandle = null;\n        this.timeoutHandle = null;\n    }\n    \n    waitUntil(checker) {\n        return new Promise((resolve, reject) => {\n            if (this.intervalHandle || this.timeoutHandle) {\n                reject(new Error('Can\\'t wait if wait is already running'));\n                return;\n            }\n            this.intervalHandle = setInterval(() => {\n                if (checker()) {\n                    this.close();\n                    resolve(true);\n                }\n            }, 500);\n            this.timeoutHandle = setTimeout(() => {\n                this.close();\n                resolve(false);\n            }, this.timeout);\n        });\n    }\n    \n    close() {\n        if (this.intervalHandle) {\n            clearInterval(this.intervalHandle);\n            this.intervalHandle = null;\n        }\n        if (this.timeoutHandle) {\n            clearTimeout(this.timeoutHandle);\n            this.timeoutHandle = null;\n        }\n    }\n}\n\nfunction isActivityOff() {\n    const state = flow.get(\"harmonyhub\");\n    return state && state.status === 0;\n}\n\n(async function() {\n    try {\n        if (isActivityOff()) {\n            node.send({ payload: true });\n        } else {\n            const waiter = new Waiter(10000);\n            node.on('close', () => waiter.close());\n            const success = await waiter.waitUntil(() => isActivityOff());\n            if (success) {\n                // Give controlled devices time to properly shutdown\n                await new Promise(resolve => setTimeout(resolve, 5000));\n            }\n            node.send({ payload: success });\n        }\n    } catch(error) {\n        node.error('Waiter failed:', error);\n        node.send({ payload: false });\n    } finally {\n        node.done();\n    }\n})();\nreturn;\n","outputs":1,"noerr":0,"x":370,"y":600,"wires":[["3a14d88c.09df88"]]},{"id":"3a14d88c.09df88","type":"switch","z":"3c42ee28.883e0a","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":600,"wires":[["7ea83549.1bf8cc"]]},{"id":"f7d3061c.7f37","type":"debug","z":"3c42ee28.883e0a","name":"Harmony hub tila","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":760,"y":160,"wires":[]},{"id":"4cfc37bc.d653e","type":"inject","z":"3c42ee28.883e0a","name":"Turn off","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":570,"y":660,"wires":[["7ea83549.1bf8cc"]]},{"id":"cac26245.12e7","type":"comment","z":"3c42ee28.883e0a","name":"Olohuoneen kattovalaisimen ohjaus","info":"","x":180,"y":720,"wires":[]},{"id":"188b7890.062617","type":"mqtt in","z":"3c42ee28.883e0a","name":"tradfri-kaukosaadin-1","topic":"zigbee2mqtt/tradfri-kaukosaadin-1","qos":"2","datatype":"auto","broker":"2ec0e647.0b10ba","x":150,"y":800,"wires":[["4d430381.ff6104"]]},{"id":"4d430381.ff6104","type":"json","z":"3c42ee28.883e0a","name":"","property":"payload","action":"","pretty":false,"x":330,"y":800,"wires":[["5950701a.f1bad"]]},{"id":"5950701a.f1bad","type":"function","z":"3c42ee28.883e0a","name":"Säädä värilämpotilaa","func":"const VARI_LAMPOTILAT = [150, 300, 375, 450];\n\nfunction vaihdaLampotila(muutos) {\n    let lampotila = flow.get('olohuone-kattovalaisin-lampotila') || 0;\n    lampotila += muutos;\n    lampotila = lampotila < 0 ? VARI_LAMPOTILAT.length -1 : lampotila;\n    lampotila = lampotila >= VARI_LAMPOTILAT.length ? 0 : lampotila;\n    flow.set('olohuone-kattovalaisin-lampotila', lampotila);\n    return VARI_LAMPOTILAT[lampotila];\n}\n\nswitch (msg.payload.action) {\ncase 'arrow_right_click':\n    msg.payload = {\n        color_temp: vaihdaLampotila(+1)\n    };\n    break;\ncase 'arrow_left_click':\n    msg.payload = {\n        color_temp: vaihdaLampotila(-1)\n    };\n    break;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":500,"y":800,"wires":[["1659c5e4.f2b89a"]]},{"id":"1659c5e4.f2b89a","type":"mqtt out","z":"3c42ee28.883e0a","name":"","topic":"zigbee2mqtt/olohuone-kattovalaisin/set","qos":"","retain":"","broker":"2ec0e647.0b10ba","x":770,"y":800,"wires":[]},{"id":"201b2c59.c613bc","type":"mqtt in","z":"3c42ee28.883e0a","name":"","topic":"zigbee2mqtt/olohuone-kattovalaisin","qos":"2","datatype":"auto","broker":"2ec0e647.0b10ba","x":230,"y":940,"wires":[["21802c00.e03034"]]},{"id":"21802c00.e03034","type":"debug","z":"3c42ee28.883e0a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":490,"y":940,"wires":[]},{"id":"b4cb8d98.959298","type":"inject","z":"3c42ee28.883e0a","d":true,"name":"Sulje klo 22.00","repeat":"","crontab":"00 22 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"{\"click\":\"long\"}","payloadType":"str","x":120,"y":400,"wires":[["17bd2a9c.3d66a5"]]}]